<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google 授权中间页</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: #f8f9fa;
      }
      main {
        width: min(420px, 100%);
        background: #fff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
      }
      p {
        color: #4b5563;
        line-height: 1.6;
      }
      button {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        background: #1a73e8;
        color: #fff;
      }
      #log {
        margin-top: 16px;
        font-size: 0.9rem;
        color: #6b7280;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Google OAuth 中间页</h1>
      <p>
        该页面接收 Flutter iOS 端提供的 Client ID，完成 Google 登录后将
        accessToken / id / email / displayName / photoUrl 等信息通过
        postMessage 返回。
      </p>
      <button id="loginBtn">使用 Google 登录</button>
      <div id="log"></div>
    </main>

    <script>
      const log = (msg) => {
        const logEl = document.getElementById("log");
        logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      };

      // 解析 URL 中的查询参数，Flutter 端需至少传 clientId
      const params = new URLSearchParams(window.location.search);
      const clientId = params.get("clientId");
      const nonce = params.get("nonce") || crypto.randomUUID();

      if (!clientId) {
        log("缺少 clientId，无法初始化 Google 登录");
      }

      let googleTokenClient;
      let bootstrapAttempts = 0;

      const bootstrapGoogleClient = () => {
        if (!clientId) {
          log("缺少 clientId，无法初始化 Google 登录");
          return;
        }
        if (!window.google || !google.accounts || !google.accounts.oauth2) {
          bootstrapAttempts += 1;
          if (bootstrapAttempts % 5 === 0) {
            log("Google SDK 尚未加载，稍后自动重试...");
          }
          window.requestAnimationFrame(bootstrapGoogleClient);
          return;
        }

        googleTokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope:
            "openid email profile https://www.googleapis.com/auth/userinfo.profile",
          callback: handleCredentialResponse,
          prompt: "consent",
          nonce,
        });

        log("Google Token Client 初始化成功，等待用户点击登录按钮");
      };

      window.addEventListener("load", bootstrapGoogleClient);

      document.getElementById("loginBtn").addEventListener("click", () => {
        if (!googleTokenClient) {
          log("Google Token Client 未就绪，正在重试初始化...");
          bootstrapGoogleClient();
          return;
        }
        googleTokenClient.requestAccessToken();
      });

      async function handleCredentialResponse(tokenResponse) {
        try {
          log("获取 accessToken 成功，拉取用户信息...");
          const userInfo = await fetch(
            "https://www.googleapis.com/oauth2/v3/userinfo",
            {
              headers: {
                Authorization: `Bearer ${tokenResponse.access_token}`,
              },
            }
          ).then((res) => res.json());

          const payload = {
            accessToken: tokenResponse.access_token,
            id: userInfo.sub,
            email: userInfo.email,
            displayName: userInfo.name,
            photoUrl: userInfo.picture,
            expiresIn: tokenResponse.expires_in,
            issuedAt: Date.now(),
            nonce,
          };

          // 将结果返回给 Flutter 宿主。若在 SFSafariViewController 中，可使用 window.webkit.messageHandlers。
          if (window.opener) {
            window.opener.postMessage(payload, params.get("origin") || "*");
            log("结果已通过 window.opener.postMessage 发送");
          }
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify(payload));
            log("结果已通过 ReactNativeWebView.postMessage 发送");
          }
          if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.googleAuthBridge) {
            window.webkit.messageHandlers.googleAuthBridge.postMessage(payload);
            log("结果已通过 iOS message handler 发送");
          }
        } catch (err) {
          log(`拉取用户信息失败: ${err.message}`);
        }
      }
    </script>
  </body>
</html>
