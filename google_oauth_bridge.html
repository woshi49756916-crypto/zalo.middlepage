<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google 授权中间页</title>
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
      onload="initialize()"
      onerror="(function() {
        const msg = 'Google SDK 脚本加载失败（可能被网络或 ATS 拦截）';
        console.error(msg);
        var errorBox = document.getElementById('error');
        if (errorBox) errorBox.textContent = msg;
        if (window.AppBridge && window.AppBridge.postMessage) {
          window.AppBridge.postMessage(JSON.stringify({ error: msg, provider: 'google' }));
        } else if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ error: msg, provider: 'google' }));
        }
      })()"
    ></script>
    <style>
      :root {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f6f7fb;
        color: #1f1f1f;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(420px, 90vw);
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 20px 35px rgba(15, 23, 42, 0.1);
        padding: 32px 36px;
        text-align: center;
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
      }
      p {
        font-size: 0.95rem;
        color: #555;
      }
      button {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        background: #1a73e8;
        color: #fff;
        font-size: 1rem;
        border: none;
        border-radius: 12px;
        padding: 14px 20px;
        cursor: pointer;
        margin-top: 18px;
        transition: background 0.2s ease;
      }
      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }
      pre {
        text-align: left;
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 12px;
        max-height: 240px;
        overflow: auto;
        margin-top: 20px;
      }
      .error {
        color: #c53030;
        margin-top: 18px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Google 授权中间页</h1>
      <p id="message">正在初始化...</p>
      <button id="authButton" disabled>使用 Google 登录</button>
      <div id="debug" hidden>
        <p>调试输出：</p>
        <pre id="result"></pre>
      </div>
      <p class="error" id="error"></p>
    </div>

    <script>
      const authButton = document.getElementById("authButton");
      const errorBox = document.getElementById("error");
      const messageBox = document.getElementById("message");
      const debugBox = document.getElementById("debug");
      const resultBox = document.getElementById("result");
      const urlParams = new URLSearchParams(window.location.search);
      const clientId = urlParams.get("client_id");
      const debug = urlParams.get("debug") === "true";
      let tokenClient = null;

      function reportError(text) {
        errorBox.textContent = text;
        console.error(text);
      }

      function postToHost(payload) {
        const serialized = JSON.stringify(payload);
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(serialized);
        }
        if (window.AppBridge?.postMessage) {
          window.AppBridge.postMessage(serialized);
        }
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(payload, "*");
        }
        if (debug) {
          debugBox.hidden = false;
          resultBox.textContent = serialized;
        }
      }

      function buildPayload(tokenResponse, profile) {
        return {
          accessToken: tokenResponse?.access_token ?? "",
          expireIn: tokenResponse?.expires_in ?? 0,
          idToken: tokenResponse?.id_token ?? "",
          id: profile?.sub ?? "",
          email: profile?.email ?? "",
          emailVerified: profile?.email_verified ?? false,
          displayName: profile?.name ?? "",
          givenName: profile?.given_name ?? "",
          familyName: profile?.family_name ?? "",
          photoUrl: profile?.picture ?? "",
          locale: profile?.locale ?? "",
          provider: "google",
          timestamp: Date.now(),
        };
      }

      async function initialize() {
        if (!clientId) {
          reportError("缺少 client_id 参数，无法继续。");
          messageBox.textContent = "请从 App 端传入 client_id。";
          return;
        }
        messageBox.textContent = "正在加载 Google 登录组件...";
        authButton.disabled = true;
        try {
          if (!window.google || !google.accounts || !google.accounts.oauth2) {
            throw new Error("Google SDK 未正确初始化");
          }
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: clientId,
            scope: "openid email profile",
            callback: async (tokenResponse) => {
              try {
                if (!tokenResponse?.access_token) {
                  throw new Error("Google 返回的 access_token 为空");
                }
                const profileResp = await fetch(
                  "https://www.googleapis.com/oauth2/v3/userinfo",
                  {
                    headers: {
                      Authorization: `Bearer ${tokenResponse.access_token}`,
                    },
                  }
                );
                if (!profileResp.ok) {
                  throw new Error("获取用户信息失败");
                }
                const profile = await profileResp.json();
                postToHost(buildPayload(tokenResponse, profile));
                messageBox.textContent = "授权成功，数据已发送给 App。";
              } catch (err) {
                reportError(err.message);
                postToHost({ error: err.message, provider: "google" });
              }
            },
            error_callback: (err) => {
              const message = err?.message || "用户取消或授权失败";
              reportError(message);
              postToHost({ error: message, provider: "google" });
            },
          });
          messageBox.textContent = "已获取 client_id，等待用户授权。";
          authButton.disabled = false;
        } catch (err) {
          const msg = err.message || "Google 登录 SDK 加载失败";
          reportError(msg);
          postToHost({ error: msg, provider: "google" });
        }
      }

      authButton.addEventListener("click", () => {
        if (!tokenClient) {
          reportError("TokenClient 尚未就绪");
          return;
        }
        messageBox.textContent = "等待 Google 返回授权结果...";
        tokenClient.requestAccessToken({ prompt: "consent" });
      });

      window.addEventListener("message", (event) => {
        if (event.data?.type === "update_client_id" && event.data.clientId) {
          urlParams.set("client_id", event.data.clientId);
          initialize();
        }
      });

      // initialize 现由 <script> 的 onload 触发，这里不再监听 DOMContentLoaded
    </script>
  </body>
</html>
